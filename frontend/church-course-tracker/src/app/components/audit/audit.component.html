<div class="audit-container">
  <div class="header">
    <h1>System Audit Logs</h1>
    <p class="subtitle">Monitor system changes and user activities</p>
  </div>

  <!-- Summary Cards -->
  <div class="summary-section" *ngIf="summary">
    <mat-card class="summary-card">
      <mat-card-header>
        <mat-card-title>Total Activity</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="summary-stat">
          <h2>{{ summary.total_logs }}</h2>
          <p>Total Logs</p>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="summary-card">
      <mat-card-header>
        <mat-card-title>Actions</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="action-stats">
          <div class="action-stat" *ngFor="let action of summary.action_breakdown | keyvalue">
            <span class="action-label">{{ getActionDisplayName(action.key) }}</span>
            <span class="action-count">{{ action.value }}</span>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="summary-card">
      <mat-card-header>
        <mat-card-title>Tables</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="table-stats">
          <div class="table-stat" *ngFor="let table of summary.table_breakdown | keyvalue">
            <span class="table-label">{{ getTableDisplayName(table.key) }}</span>
            <span class="table-count">{{ table.value }}</span>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Filters -->
  <mat-card class="filters-card">
    <mat-card-header>
      <mat-card-title>Filters</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="filters-row">
        <mat-form-field appearance="outline">
          <mat-label>Table</mat-label>
          <mat-select [(value)]="filters.table_name" (selectionChange)="onFilterChange()">
            <mat-option [value]="null">All Tables</mat-option>
            <mat-option *ngFor="let table of summary?.table_breakdown | keyvalue" [value]="table.key">
              {{ getTableDisplayName(table.key) }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Action</mat-label>
          <mat-select [(value)]="filters.action" (selectionChange)="onFilterChange()">
            <mat-option [value]="null">All Actions</mat-option>
            <mat-option *ngFor="let action of availableActions" [value]="action">
              {{ getActionDisplayName(action) }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>User</mat-label>
          <mat-select [(value)]="filters.changed_by" (selectionChange)="onFilterChange()">
            <mat-option [value]="null">All Users</mat-option>
            <mat-option *ngFor="let user of availableUsers" [value]="user.id">
              {{ user.full_name }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Start Date</mat-label>
          <input matInput type="date" [(ngModel)]="filters.start_date" (change)="onFilterChange()">
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>End Date</mat-label>
          <input matInput type="date" [(ngModel)]="filters.end_date" (change)="onFilterChange()">
        </mat-form-field>

        <button mat-raised-button color="warn" (click)="clearFilters()">
          <mat-icon>clear</mat-icon>
          Clear Filters
        </button>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Export Actions -->
  <div class="export-actions">
    <button mat-raised-button color="primary" (click)="exportAuditLogs('csv')">
      <mat-icon>download</mat-icon>
      Export CSV
    </button>
    <button mat-raised-button color="accent" (click)="exportAuditLogs('json')">
      <mat-icon>download</mat-icon>
      Export JSON
    </button>
  </div>

  <!-- Audit Logs Table -->
  <mat-card class="logs-card">
    <mat-card-header>
      <mat-card-title>Audit Logs</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="table-container" *ngIf="!isLoading">
        <table mat-table [dataSource]="auditLogs" class="audit-table">
          <!-- Timestamp Column -->
          <ng-container matColumnDef="timestamp">
            <th mat-header-cell *matHeaderCellDef>Timestamp</th>
            <td mat-cell *matCellDef="let log">
              {{ formatAuditTimestamp(log.changed_at) }}
            </td>
          </ng-container>

          <!-- Action Column -->
          <ng-container matColumnDef="action">
            <th mat-header-cell *matHeaderCellDef>Action</th>
            <td mat-cell *matCellDef="let log">
              <mat-chip [color]="getActionColor(log.action)" selected>
                <mat-icon matChipAvatar>{{ getActionIcon(log.action) }}</mat-icon>
                {{ getActionDisplayName(log.action) }}
              </mat-chip>
            </td>
          </ng-container>

          <!-- Table Column -->
          <ng-container matColumnDef="table">
            <th mat-header-cell *matHeaderCellDef>Table</th>
            <td mat-cell *matCellDef="let log">
              <div class="table-cell">
                <mat-icon>{{ getTableIcon(log.table_name) }}</mat-icon>
                <span>{{ getTableDisplayName(log.table_name) }}</span>
              </div>
            </td>
          </ng-container>

          <!-- Record ID Column -->
          <ng-container matColumnDef="record_id">
            <th mat-header-cell *matHeaderCellDef>Record ID</th>
            <td mat-cell *matCellDef="let log">{{ log.record_id }}</td>
          </ng-container>

          <!-- User Column -->
          <ng-container matColumnDef="user">
            <th mat-header-cell *matHeaderCellDef>User</th>
            <td mat-cell *matCellDef="let log">
              {{ log.changed_by ? getUserName(log.changed_by) : 'System' }}
            </td>
          </ng-container>

          <!-- Changes Column -->
          <ng-container matColumnDef="changes">
            <th mat-header-cell *matHeaderCellDef>Changes</th>
            <td mat-cell *matCellDef="let log">
              <div class="changes-cell">
                <div *ngIf="log.old_values" class="old-values">
                  <strong>Old:</strong> {{ formatAuditValues(log.old_values) }}
                </div>
                <div *ngIf="log.new_values" class="new-values">
                  <strong>New:</strong> {{ formatAuditValues(log.new_values) }}
                </div>
              </div>
            </td>
          </ng-container>

          <!-- Actions Column -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Actions</th>
            <td mat-cell *matCellDef="let log">
              <button mat-icon-button (click)="viewAuditDetails(log)" matTooltip="View Details">
                <mat-icon>visibility</mat-icon>
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="['timestamp', 'action', 'table', 'record_id', 'user', 'changes', 'actions']"></tr>
          <tr mat-row *matRowDef="let row; columns: ['timestamp', 'action', 'table', 'record_id', 'user', 'changes', 'actions'];"></tr>
        </table>
      </div>

      <!-- Loading Spinner -->
      <div class="loading-container" *ngIf="isLoading">
        <mat-spinner></mat-spinner>
        <p>Loading audit logs...</p>
      </div>

      <!-- No Data -->
      <div class="no-data" *ngIf="!isLoading && auditLogs.length === 0">
        <mat-icon>history</mat-icon>
        <h3>No audit logs found</h3>
        <p>No audit logs match your current filters.</p>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Pagination -->
  <mat-paginator
    *ngIf="!isLoading && auditLogs.length > 0"
    [length]="totalCount"
    [pageSize]="pageSize"
    [pageSizeOptions]="[25, 50, 100]"
    (page)="onPageChange($event)"
    showFirstLastButtons>
  </mat-paginator>
</div>


